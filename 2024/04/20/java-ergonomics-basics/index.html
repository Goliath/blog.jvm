<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Bitecode blog"><meta property="og:type" content="article"><meta property="og:image" content="https://bitecode.blog//img/bg_water.webp"><meta property="twitter:image" content="https://bitecode.blog//img/bg_water.webp"><meta name=title content="Introduction to Java ergonomics"><meta property="og:title" content="Introduction to Java ergonomics"><meta property="twitter:title" content="Introduction to Java ergonomics"><meta name=description content="Defaults are not always safe."><meta property="og:description" content="Defaults are not always safe."><meta property="twitter:description" content="Defaults are not always safe."><meta property="twitter:card" content="summary"><meta name=keyword content="JVM, java, openjdk, jdk, performance, profiling, debugging, speed, bytecode, software craftsmanship, design patterns, java speed"><link rel="shortcut icon" href=/img/favicon.ico><title>Introduction to Java ergonomics | Marcin Szlagor's blog on JVM technologies</title>
<link rel=canonical href=/2024/04/20/java-ergonomics-basics/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script><script src=/js/bootstrap.min.js></script><script src=/js/hux-blog.min.js></script><script src=/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Bitecode blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/groovy/>groovy</a></li><li><a href=/categories/jvm/>jvm</a></li><li><a href=/categories/performance/>performance</a></li><li><a href=/categories/security/>security</a></li><li><a href=/categories/tips/>tips</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/bg_water.webp)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/java title=JAVA>JAVA
</a><a class=tag href=/tags/jvm title=JVM>JVM
</a><a class=tag href=/tags/java-ergonomics title="Java Ergonomics">Java Ergonomics</a></div><h1>Introduction to Java ergonomics</h1><h2 class=subheading></h2><span class=meta>Posted by
Marcin
on
Saturday, April 20, 2024</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h2 id=intro>Intro</h2><p>It&rsquo;s not a secret that JVM is an extremly complex execution environment. It has many options that can be set to tune the application execution.
What happens if we don&rsquo;t set any of them or we pick only few?
In this article I will explain what is Java ergonomics and how it works to supply default JVM options.
I will also tell why it&rsquo;s never safe to rely on the defaults.</p><h2 id=problem>Problem</h2><p>Most of the time when we setup JAVA_OPTS we are doing it to tune the application performance.
What happens when we don&rsquo;t set any of them?
Java ergonomics comes to the rescue.</p><h2 id=java-ergonomics>Java ergonomics</h2><p>By <a href=https://docs.oracle.com/en/java/javase/17/gctuning/ergonomics.html>Oracle</a>:</p><blockquote><p>Ergonomics is the process by which the Java Virtual Machine (JVM) and garbage collection heuristics, such as behavior-based heuristics, improve application performance.</p></blockquote><p>Java ergonomics checks existing system resources and sets the JVM options accordingly. It can set the heap size, garbage collector, and other options based on the available memory, CPU, and other resources.</p><h3 id=how-is-ergonomics-deciding-on-which-garbage-collector-to-pick>How is Ergonomics deciding on which Garbage Collector to pick?</h3><p>Our JVM (jdk17) has six garbage collectors:</p><ul><li>SerialGC</li><li>ParallelGC</li><li>G1GC</li><li>ZGC</li><li>ShenandoahGC</li><li>EpsilonGC.</li></ul><p>It&rsquo;s worth to know that from above list only two GC&rsquo;s are picked ergonomics:</p><ul><li>SerialGC</li><li>G1GC</li></ul><p>How is Ergonomics deciding on which Garbage Collector to pick? Let&rsquo;s find out!</p><p>We will use PrintFinalFlags to see what options are set.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> docker run --memory<span style=color:#ff79c6>=</span>1GB --cpus<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;1.0&#34;</span> azul/zulu-openjdk-alpine:17-latest java -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version
</span></span></code></pre></div><p>Of course that produces a lot of output, most of them are static defaults, so we will narrow the results to ones that are java ergonomics changes:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> docker run --memory<span style=color:#ff79c6>=</span>1GB --cpus<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;1.0&#34;</span> azul/zulu-openjdk-alpine:17-latest java -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | grep ergonomic
</span></span></code></pre></div><p>Here are JVM options adjustments done by java ergonomics for 1GB of RAM and 1 CPU:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>     intx <span style=color:#8be9fd;font-style:italic>CICompilerCount</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>InitialHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>16777216</span>                                  <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MaxHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>268435456</span>                                 <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MaxNewSize</span>                               <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>89456640</span>                                  <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MinHeapDeltaBytes</span>                        <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>196608</span>                                    <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MinHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8388608</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>NewSize</span>                                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5570560</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonNMethodCodeHeapSize</span>                   <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5826188</span>                                <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonProfiledCodeHeapSize</span>                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>OldSize</span>                                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>11206656</span>                                  <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>ProfiledCodeHeapSize</span>                     <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>ReservedCodeCacheSize</span>                    <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>251658240</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>SegmentedCodeCache</span>                       <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                                      <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>SoftMaxHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>268435456</span>                              <span style=color:#ff79c6>{</span>manageable<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>THPStackMitigation</span>                       <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>false</span>                                  <span style=color:#ff79c6>{</span>diagnostic<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseCompressedClassPointers</span>               <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                           <span style=color:#ff79c6>{</span>product lp64_product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseCompressedOops</span>                        <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                           <span style=color:#ff79c6>{</span>product lp64_product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseSerialGC</span>                              <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                                      <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>Among those changes we can spot SerialGC being picked by java ergonomics.</p><p>In short - G1GC is used when:</p><ul><li>available operational memory is <strong>1792 MB</strong> or more</li><li>there is more then one CPU cores available</li></ul><p>otherwise SerialGC is picked.</p><p>Using below specs will make JVM to pick G1GC:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> docker run --memory<span style=color:#ff79c6>=</span>1792MB --cpus<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;2.0&#34;</span> azul/zulu-openjdk-alpine:17-latest java -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | grep ergonomic
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>     intx <span style=color:#8be9fd;font-style:italic>CICompilerCount</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     uint <span style=color:#8be9fd;font-style:italic>ConcGCThreads</span>                            <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     uint <span style=color:#8be9fd;font-style:italic>G1ConcRefinementThreads</span>                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>G1HeapRegionSize</span>                         <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1048576</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>GCDrainStackTargetSize</span>                   <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>64</span>                                        <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>InitialHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>29360128</span>                                  <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MarkStackSize</span>                            <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4194304</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MaxHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>469762048</span>                                 <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MaxNewSize</span>                               <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>281018368</span>                                 <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MinHeapDeltaBytes</span>                        <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1048576</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MinHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8388608</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonNMethodCodeHeapSize</span>                   <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5826188</span>                                <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonProfiledCodeHeapSize</span>                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>ProfiledCodeHeapSize</span>                     <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>ReservedCodeCacheSize</span>                    <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>251658240</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>SegmentedCodeCache</span>                       <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                                      <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>SoftMaxHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>469762048</span>                              <span style=color:#ff79c6>{</span>manageable<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>THPStackMitigation</span>                       <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>false</span>                                  <span style=color:#ff79c6>{</span>diagnostic<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseCompressedClassPointers</span>               <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                           <span style=color:#ff79c6>{</span>product lp64_product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseCompressedOops</span>                        <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                           <span style=color:#ff79c6>{</span>product lp64_product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseG1GC</span>                                  <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                                      <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span></code></pre></div><h3 id=why-this-magic-number>Why this magic number?</h3><p>Java picks G1GC when your machine is considered a <strong>server-class</strong> machine.
The threshold of 1792MB is based on the assumption that machines with more than 2GB of RAM qualify as server-class.
As often some RAM can be reserved by OS for integrated GPU - that&rsquo;s how this magic number was born.</p><p>In case you would like to see the implementation - it&rsquo;s <a href=https://github.com/openjdk/jdk17u/blob/ff14ed4af37e465b928e55af220dbb287f6d2bc0/src/hotspot/share/runtime/os.cpp#L1714>here</a>.</p><h3 id=how-is-my-default-heap-size-calculated>How is my default heap size calculated?</h3><p>Again we could use brute-force method and execute above docker command few times with different params, but I try to shorten that process and present how it looks below.</p><p>Ergonomics is calculating the heap size based on the available memory. The process is however nonlinear. There are three different formulas used to calculate the heap size:</p><ul><li>for machines with RAM less then 256 MB, max heap size is 1/2 of RAM</li><li>for machines with RAM more then 256 MB but less then 512 MB, max heap size is 127 MB</li><li>for machines with RAM more then 512 MB, max heap size is 1/4 of RAM</li></ul><h3 id=why-its-not-safe-to-use-defaults>Why it&rsquo;s not safe to use defaults?</h3><p>Let&rsquo;s say you have 2GB RAM and 2 CPU VPS instance.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> docker run --memory<span style=color:#ff79c6>=</span>2G --cpus<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;2.0&#34;</span> azul/zulu-openjdk-alpine:17-latest java -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | grep ergonomic
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>     intx <span style=color:#8be9fd;font-style:italic>CICompilerCount</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     uint <span style=color:#8be9fd;font-style:italic>ConcGCThreads</span>                            <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     uint <span style=color:#8be9fd;font-style:italic>G1ConcRefinementThreads</span>                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>G1HeapRegionSize</span>                         <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1048576</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>GCDrainStackTargetSize</span>                   <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>64</span>                                        <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>InitialHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>33554432</span>                                  <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MarkStackSize</span>                            <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>4194304</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MaxHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>536870912</span>                                 <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MaxNewSize</span>                               <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>321912832</span>                                 <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MinHeapDeltaBytes</span>                        <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1048576</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MinHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8388608</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonNMethodCodeHeapSize</span>                   <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5826188</span>                                <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonProfiledCodeHeapSize</span>                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>ProfiledCodeHeapSize</span>                     <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>ReservedCodeCacheSize</span>                    <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>251658240</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>SegmentedCodeCache</span>                       <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                                      <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>SoftMaxHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>536870912</span>                              <span style=color:#ff79c6>{</span>manageable<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>THPStackMitigation</span>                       <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>false</span>                                  <span style=color:#ff79c6>{</span>diagnostic<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseCompressedClassPointers</span>               <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                           <span style=color:#ff79c6>{</span>product lp64_product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseCompressedOops</span>                        <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                           <span style=color:#ff79c6>{</span>product lp64_product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>     bool <span style=color:#8be9fd;font-style:italic>UseG1GC</span>                                  <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>                                      <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>Ergonomics will suggest using G1GC, but max heap size will be setup to only 512MB. Does it sound good for you?
That might be correct if we run JVM on our local machine as we still want to have some room for other applications.
However, if we run JVM on a dedicated server / kubernates pod, we might want to use all available resources, as we don&rsquo;t plan to share them with other applications.</p><p>In this case you might want to set:</p><ul><li>-XX:MaxRAMPercentage=80.0</li><li>-XX:InitialRAMPercentage=80.0</li></ul><p>This will assign 80% of available OS memory to the heap. From my experience it&rsquo;s good factor to start with, as one needs to remember that JVM is not only heap memory, but also metaspace, code cache, thread stacks, etc.</p><p>Let&rsquo;s see that in action:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> docker run --memory<span style=color:#ff79c6>=</span>2G --cpus<span style=color:#ff79c6>=</span><span style=color:#f1fa8c>&#34;2.0&#34;</span> azul/zulu-openjdk-alpine:17-latest java -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -XX:InitialRAMPercentage<span style=color:#ff79c6>=</span>80.0 -XX:MaxRAMPercentage<span style=color:#ff79c6>=</span>80.0 -version | grep -E <span style=color:#f1fa8c>&#34;HeapSize&#34;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>ErgoHeapSizeLimit</span>                        <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>0</span>                                         <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>default<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>HeapSizePerGCThread</span>                      <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>43620760</span>                                  <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>default<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>InitialHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1719664640</span>                                <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>LargePageHeapSizeThreshold</span>               <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>134217728</span>                                 <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>default<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MaxHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1719664640</span>                                <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>MinHeapSize</span>                              <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>8388608</span>                                   <span style=color:#ff79c6>{</span>product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonNMethodCodeHeapSize</span>                   <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>5826188</span>                                <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>NonProfiledCodeHeapSize</span>                  <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>    uintx <span style=color:#8be9fd;font-style:italic>ProfiledCodeHeapSize</span>                     <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>122916026</span>                              <span style=color:#ff79c6>{</span>pd product<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span><span style=display:flex><span>   size_t <span style=color:#8be9fd;font-style:italic>SoftMaxHeapSize</span>                          <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>1719664640</span>                             <span style=color:#ff79c6>{</span>manageable<span style=color:#ff79c6>}</span> <span style=color:#ff79c6>{</span>ergonomic<span style=color:#ff79c6>}</span>
</span></span></code></pre></div><p>In our case the resulting Xms and Xmx are ~1.7GB. Operating on percentages is a good practice as it allows to scale the application without the need to change the JVM options.</p><h2 id=summary>Summary</h2><p>JVM has a lot of options that need some default values. While Java ergonomics strives to set reasonable defaults, they may not always align with your application&rsquo;s needs. Always customize JVM options based on your unique circumstances, and never hesitate to override the defaults when necessary.</p><hr><ul class=pager><li class=previous><a href=/2024/04/05/jvm-serialization-exploits/ data-toggle=tooltip data-placement=top title="Serialization exploits in JVM">&larr;
Previous Post</a></li></ul><div id=disqus-comment></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//disqus_HTDDbyZ6mV.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/groovy title=groovy>groovy
</a><a href=/tags/jvm title=jvm>jvm</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:marcin.szlagor@codeappeal.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/Goliath><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/marcinszlagor/><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Bitecode blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Bitecode blog 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>